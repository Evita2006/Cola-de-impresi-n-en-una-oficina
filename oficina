import queue
import threading
import time
import random
import json
from datetime import datetime

# Crear la cola compartida (PriorityQueue)
q = queue.PriorityQueue()

# Lista para guardar el historial y un Lock para protegerla
registro_impresiones = []
lock_registro = threading.Lock()

def empleado(id_empleado):
    """Productor: Simula a un empleado enviando documentos."""
    for i in range(5):
        prioridad = random.randint(1, 3)
        documento = f"Doc-{i+1} del Empleado-{id_empleado}"
        
        q.put((prioridad, documento))
        print(f"Empleado {id_empleado} envio: {documento} [Prioridad: {prioridad}]")
        
        time.sleep(random.uniform(0.5, 1.5))

def impresora(id_impresora):
    """Consumidor: Simula una impresora procesando la cola."""
    while True:
        if random.random() < 0.15:
            print(f"Â¡ALERTA! Impresora {id_impresora} atascada o sin papel. Mantenimiento en curso...")
            time.sleep(4)
            print(f"Impresora {id_impresora} reparada y lista para continuar.")

        prioridad, documento = q.get()
        
        if documento is None:
            q.task_done()
            break
            
        print(f"Impresora {id_impresora} imprimiendo: {documento} [Prioridad {prioridad}]")
        
        time.sleep(random.uniform(1.0, 3.0))
        
        print(f"Impresora {id_impresora} termino: {documento}")
        
        # --- MEJORA: Guardar en el registro de forma segura ---
        hora_actual = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        with lock_registro: # Bloqueamos el acceso a la lista mientras escribimos
            registro_impresiones.append({
                "impresora": f"Impresora-{id_impresora}",
                "documento": documento,
                "prioridad": prioridad,
                "hora_impresion": hora_actual
            })
        # ------------------------------------------------------
        
        q.task_done()

# --- CONFIGURACION Y LANZAMIENTO ---

num_empleados = 3
num_impresoras = 2

hilos_empleados = []
hilos_impresoras = []

for i in range(num_impresoras):
    t = threading.Thread(target=impresora, args=(i+1,))
    hilos_impresoras.append(t)
    t.start()

for i in range(num_empleados):
    t = threading.Thread(target=empleado, args=(i+1,))
    hilos_empleados.append(t)
    t.start()

for t in hilos_empleados:
    t.join()

for _ in range(num_impresoras):
    q.put((999, None))

for t in hilos_impresoras:
    t.join()

print("Todos los documentos han sido procesados. Generando archivo JSON...")

# --- MEJORA: Exportar la lista a un archivo JSON ---
nombre_archivo = "historial_impresiones.json"
with open(nombre_archivo, "w", encoding="utf-8") as archivo:
    json.dump(registro_impresiones, archivo, indent=4, ensure_ascii=False)

print(f"Sistema apagado. El registro se ha guardado en '{nombre_archivo}'.")